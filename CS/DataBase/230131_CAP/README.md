- [CAP](#cap)
  - [CAP 정리](#cap-정리)
    - [CAP 특성](#cap-특성)
      - [Consistency](#consistency)
      - [Availability](#availability)
      - [Partition Tolerance](#partition-tolerance)
    - [CAP정리 기반 NoSQL 데이터베이스 유형](#cap정리-기반-nosql-데이터베이스-유형)
      - [CP 데이터베이스 예시 : MongoDB](#cp-데이터베이스-예시--mongodb)
      - [AP 데이터베이스 예시 : Cassandra](#ap-데이터베이스-예시--cassandra)
    - [마이크로서비스에 대한 작업](#마이크로서비스에-대한-작업)


# CAP

## CAP 정리

- NoSQL과 같은 분산형 데이터베이스들은 위 3개의 특성중 1개의 특성을 희생하고 나머지 2개 특성을 갖춘다.

- 둘 이상의 노드에 데이터를 저장하는 **분산 시스템** 데이터베이스 3가지 특성
  
  - **일관성(Consistency)**
  
  - **가용성(Availability)**
  
  - **파티션 허용(Partition tolerance)**

### CAP 특성

#### Consistency

- 어떤 노드에 연결되었는지와 무관하게 모든 클라이언트가 동일 데이터를 조회가능하다.

- 데이터가 하나의 노드에 기록될 때마다 해당 "쓰기" 작업이 "성공"으로 간주되기 전에 시스템의 다른 모든 노드로 즉시 전달되거나 복제되어야 한다.

#### Availability

- 분산 시스템을 구성하는 여러 노드중 하나의 노드가 작동 중지된 경우에도 클라이언트의 데이터 요청에도 응답한다.

- 즉, 분산 시스템의 모든 작업 노드는 예외 없이 모든 요청에 대해 유효한 응답을 반환한다.

- 단일 실패점(Single point failure)가 존재하지 않는다.

#### Partition Tolerance

- 시스템의 노드 간의 다수의 통신 단절(파티션)에도 불구하고 클러스터가 계속 작동한다.

- 여기서 Partition(파티션)이란 분산 시스템 내의 통신 단절로 두 노드간 연결이 유실되거나 일시적으로 지연된 상태를 의미한다.

- 파티션으로 데이터가 쉽게 나눠지고 클러스터에 분산될 수 있다.

### CAP정리 기반 NoSQL 데이터베이스 유형

- NoSQL 데이터베이스는 분산 네트워크 애플리케이션에 적합하다.

- 3개 특성중 1개의 특성을 희생해야하는 CAP 정리에 기반한 NoSQL 데이터베이스는 아래 유형으로 분류된다.

- CP 데이터베이스
  
  - 가용성을 희생하면서 일관성과 파티션 허용을 제공한다.
  
  - 두 노드 간에 파티션이 발생한다면, 시스템은 파티션이 해결될때까지 일관되지 않은 노드를 종료(사용 불가능하게)해야 한다.
  
  - 예시로는 `MongoDB`가 있다.

- AP 데이터베이스
  
  - 일관성을 희생하면서 가용성과 파티션 허용을 제공한다.
  
  - 파티션이 발생하면 모든 노드를 사용할 수 있으나, 동일 시점에 동일한 2개의 요청에 다른 시점의 데이터가 반환될 수 있다.

- CA 데이터베이스
  
  - 모든 노드에서 일관성과 가용성을 제공한다.
  
  - 하지만 시스템내의 두 노드 사이에 파티션이 발생한 경우 작동할 수 없으므로 Fault Tolerance를 제공할 수 없다.

- `HDFS`와 같은 분산 시스템의 경우 파티션 허용(Partition Tolerance, 파티션 저항성)을 포기하지 못한다.
  
  - 이로 인해 `CA`데이터베이스는 이론적으로만 존재한다.

- 파티션을 중심으로 하여 위 3가지의 형태로 분류했으나 이는 **"이론적"** 인 분류에 그친다.
  
  - 실제 데이터베이스들은 1개의 특성을 완전히 희생하는 것이 아닌 **절충(Trade-off 관계)** 을 통하여 나머지 2개의 특성이 강하게 나타나는 모습을 보이기 때문이다.

#### CP 데이터베이스 예시 : MongoDB

- `CP` 데이터베이스 저장소의 예시로는 아주 유명한 `MongoDB`가 있다.

- `MongoDB`의 경우 가용성을 절충하면서도 일관성을 유지하여 네트워크 파티션을 분석한다.

- **단일 마스터 시스템**으로 작동하기 때문에 단일 실패지점이 존재하여 고가용성을 갖지 못한다.
  
  - 단일 실패로 인해 복구중에는 클러스터에 작업을 요청할 수 없으나, 복구가 완료될 시 전체 네트워크에서는 일관성을 유지하게 된다.

#### AP 데이터베이스 예시 : Cassandra

- `Apache Cassandra`는 오픈 소스 NoSQL 데이터베이스로 `AP`데이터베이스의 예시이다.

- `MongoDB`와 달리 마스터리스 아키텍쳐이며 이는 단일 실패지점이 아닌 다수의 실패 지점을 갖음을 의미한다.

- 일관성을 제공하지않지만, 클라이언트가 언제라도 노드에 작업이 가능하며 가능한 빨리 불일치를 조정함으로 궁극적인 일관성(eventually consistent)를 제공한다.

### 마이크로서비스에 대한 작업

- 마이크로서비스(Microservice)에서는 필요 목적에 따라 `CAP`정리에 부합하는 최상의 데이터베이스를 선택할 수 있다.

- 데이터모델의 빠른 접근과 유연한 구조를 갖지만 궁극적인 일관성을 허용할 수 있는 경우 `Cassandra`가 적절하며

- eCommerce와 같이 신뢰성이 필수인 경우 일관성을 갖는 `CP`데이터베이스가 적절한 선택이다.

---

- 레퍼런스

> [CAP 정리란? - 대한민국 | IBM](https://www.ibm.com/kr-ko/cloud/learn/cap-theorem)
> 
> [어떤 DB를 사용해야 할까 ? CAP 이론](https://sabarada.tistory.com/91)
