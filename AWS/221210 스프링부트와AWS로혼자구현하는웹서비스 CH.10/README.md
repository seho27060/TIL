[TOC]

# Springboot and AWS_05

## CH.10 24시간 365일 중단 없는 서비스

- 배포과정 중 새로운 Jar가 실행되기 전까지 기존 Jar를 종료하기 때문에 서비스가 중단되는 현상이 발생한다.

- 이를 방지하기 위해 무중단 서비스 배포를 적용해보자.

#### 1. 무중단 배포 소개

- 기존에 배포를 위해 시간을 정해놓고 서비스 업데이트를 진행하던 방식의 생산성 저해 요인이 다수 존재함.

- 이를 위해 서비스의 끊김이 없는 **무중단 배포**가 고안됨
  
  - AWS 블루 그린 무중단 배포
  
  - 도커를 이용한 웹서비스 무중단 배포
  
  - Ngingx

- Ngingx
  
  - 웹 서버, 리버스 프록시, 캐싱 ,로드 밸런싱, 미디어 스트리등을 위한 오픈소스 소프트웨어
  
  - EC2 혹은 리눅스 서버에 엔진엔스 1대와 스프링 부트 Jar를 2대 사용한다.
    
    - 사용자 -> Ninnx ---> springboot 1(ver 1.1/port:8080)
                                  ㄴ springboot 2(ver 1.0/port:8081)
      위와 같은 구조로 Ningx는 springboot ver 1을 바라본다.
      사용자가 서비스 접속시 Nginx를 통해 port:8080으로 접속한다.
    - 새로운 버전(ver1.2)을 배포시, Nginx가 바라보지 않은 springboot 2에 배포를 시작한다.
      - Nginx가 바라보지 않기 때문에 영향이 없다.
    - 배포 완료시 Nginx Reload를 통해 springboot2를 바라보도록 한다.
    - 서비스 사용자 입장에서 중단없는 무중단 배포 환경 구축 성공!

#### 2. 엔진엑스 설치와 스프링 부트 연동하기

- EC2에 1대의 Nginx와 2대의 springboot jar가 필요하다. 

- EC2서버에 Nginx를 설치

- Nginx가 실행 중인 스프링 부트 프로젝트를 바라 볼 수 있도록 **프록시 설정**

- Nginx와 프로젝트 연동이 완료되어, 기본 포트(80)으로 이동시 지정한 애플리케이션 프로젝트로 이동한다.

#### 3. 무중단 배포 스크립트 만들기

- 무중단 배포 스크립트 작업 전 API(url : "/profile")를 프로젝트에 추가한다.
  
  - 배포 시에 8081을 쓸지, 8082를 쓸지 판단하는 기준이 된다.

- Unit test 작성

- real1, real2 profile 생성

- 엔진엑스 설정 수정
  
  - 무중단 배포의 **핵심**
  
  - service url을 할당하고, 프록시 서버의 방향을 수정한다.

- 배포 스크립트들 작성
  
  1. `stop.sh` : 기존 엔진엑스에 연결되어 있진 않지만, 실행 중이던 스프링부트 종료
  
  2. `start.sh` : 배포할 신규 버전 스프링 부트 프로젝트를 `stop.sh`로 종료한 'profile'로 실행
  
  3. `health.sh`: `start.sh`로 실행시킨 프로젝트가 정상적으로 실행됐는지 체크
  
  4. `switch.sh`: 엔진엑스가 바라보는 스프링 부트를 최선 버전으로 변경
  
  5. `profile.sh`: 앞선 4개 스크립트 파일에서 공용으로 사용할 'profile'과 포트 체크 로직

#### 4. 무중단 배포 테스트

- 하 ^^ 왜안됨!!!!!!!!!!!!!!!!!!!!!
  - `application-real2.properties` 파일 내에서 server.port 를 server_port로 오타나서 안됐던거 였다 ^^..
- CodeDeploy의 로그를 확인하여 배포를 확인한다.
- `nohup.out`에서 스프링부트의 로그를 확인하여 프로젝트의 작동을 확인한다.
- 이를 통해 서버 중단이 없는 시스템 구축을 완료하였다!!ㄴ

---

- 레퍼런스

> 스프링 부트와 AWS로 혼자 구현하는 웹 서비스
