[TOC]

# Docker & Kubernetes 03

## 데이터 관리 및 볼륨으로 작업하기

### 데이터 카테고리

- 애플리케이션 = 소스코드 + 환경
  
  - readonly로 이미지에 저장

- 임시 애플리케이션
  
  - read-write인 컨테이너 레이어에 저장된다.
  
  - 원래 애플리케이션에 동적으로 수정된 데이터로 원래 이미지에 수정 내용이 추가된다. -> 메모리에 저장됨

- 영구 애플리케이션(Permanent App Data)
  
  - 데이터베이스에 저장되며 컨테이너의 중지, 재시작에도 남게 된다.
  
  - read-write 데이터로 영구적으로 **컨테이너**와 **볼륨**에 저장된다

#### 문제이해

- 도커의 컨테이너는 "독립적"이다.
  
  - 로컬에서 이미지 생성 - 컨테이너 실행 - 컨테이너 내부에서 파일 생성 후 저장
  
  - 위 단계를 거쳐도 생성된 새로운 파일은 로컬에서 간섭하지 못한다.
  
  - 도커의 컨테이너는 그 자체의 **독립적인(격리된,isolated) 파일 시스템**을 가지기 때문이다.
  
  - 이건 문제안됨

- 도커의 컨테이너는 "임시적"이다.
  
  - 위에서 독립적인 컨테이너를 생성하고, 그 안에서 새로운 파일 `newfile`을 생성하여 저장했다.
  
  - 이때 해당 컨테이너를 중지 후, 재시작해도 새로운 파일 `newfile`은 여전히 존재한다.
  
  - 하지만 해당 컨테이너가 삭제될 경우? -> 관련된 모든 데이터는 삭제된다.
  
  - 컨테이너가 삭제되어도 남아있어야 하는 데이터(ex : 제품 정보, 고객 정보, etc..)는 어떻게 관리해야 할까? -> Volume!

### 볼륨 소개

#### 볼륨

- **호스트 머신**에 저장된 데이터

- 마운팅되어 도커의 컨테이너 내부의 폴더에 **매핑**된다.
  
  - 컨테이너 외부의 데이터와 연결을 통해 컨테이너의 제거에 독립적인 데이터를 read/write할 수 있게 된다.

#### 볼륨 추가하기

- 익명 볼륨
  - `Dockerfile`에 `VOLUME ["저장위치"]`를 추가한다.
  - 해당 방법으로 생성된 볼륨은 "익명 볼륨"으로 실행한 컨테이너와 1대1연결이다.
  - 해당 컨테이너가 중지, 재시작 되면 "익명 볼륨" 역시 삭제된다!
    - 데이터 유지(persist) 문제가 여전히 존재함
- 명명 볼륨
  - 컨테이너와 이미지와 같이 볼륨에도 이름을 명시할 수 있다.
    - `docker run ~~ -v 볼륨이름:볼륨저장위치 이미지이름`와 같이 컨테이너를 실행할때 볼륨의 이름을 명명할 수 있다.
      - 볼륨이름을 지정하지 않으면 익명 볼륨이 생성된다.
    - 위 작업으로 명명 볼륨이 생성되었으며, 컨테이너를 실행할때 볼륨을 지정하면 해당 볼륨이 매핑된다.
    - 익명 볼륨과는 다르게 이름을 갖는 명명 볼륨은 매핑 컨테이너가 삭제되어도 같이 삭제되지 않는다!
- 볼륨 삭제
  - `docker volume rm 볼륨이름` 이나 `docker volume prune`을 통해 쌓인 익명 볼륨을 삭제할 수 있다.

#### 바인드 마운트(Bind Mounts)

- 시점 A에 생성한 이미지로 컨테이너를 실행 중이다.
  
  - 이때 페이지에 수정을 하면 해당 사항이 반영될까? -> 이미지는 시점 A의 "스냅샷"으로 해당 시점 이후 발생한 수정사항은 반영되지 않는다.
  
  - 만약 반영하기 위해선, 새로운 이미지를 빌드하고 해당 이미지로 새로운 컨테이너를 실행시켜야 한다.

- 새로운 수정사항을 반영하기 위해 새로운 이미지 빌드 - 컨테이너 실행이 아닌, 호스트 머신에 저장된 데이터(소스코드)와 컨테이너를 묶어(Bind) 반영한다(Mounts)
  
  - `docker run ~~ -v "로컬저장위치:볼륨저장위치" 이미지이름`로 바인드 마운트를 생성 가능하다.
  - 근데 WSL2를 사용하는 Windows에서는 따로 설정을 더해줘야함!

#### 요약

> `docker run -v /app/data ...` -> 익명 볼륨 생성 : 컨테이너에 종속, 도커가 관리
> 
> `docker run -v data:/app/data ...` -> 명명 볼륨 생성 : 컨테이너에 독립, 도커가 관리
> 
> `docker run -v /path/to/code:/app/code ...` -> 바인드 마운트 생성 : 컨테이너에 독립, 호스트 파일 시스템이 관리

#### dockerignore

- Dockerfile 내에서 `COPY`명령어로 복제하지 않을 파일을 지정할 수 있다.
  
  ```dockeringnore
  node_modules
  ```
  
  "COPY" 명령어의 범위내에 `node_modules`는 제외된다.

#### 환경변수(ENV) 설정

- Dockerfile 내에서 `ENV` 명령어로 설정

- `docker run ~~ -env key:value` 로 컨테이너 실행시 설정

- `.env`파일을 생성하여 KEY=VALUE 형식으로 할당후, `docker run ~~` 명령어에서 `.env`파일의 설정을 사용함을 명시

- 빌드 인수(ARG) 설정

---

- 레퍼런스

> [Udemy - Docker & Kubernetes : 실전 가이드](https://www.udemy.com/course/docker-kubernetes-2022/)
