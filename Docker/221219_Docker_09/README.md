[TOC]

# Docker & Kubernetes 09

## Docker 컨테이너 배포하기

- 도커를 활용하여 웹 어플리케이션을 리모트 머신에 배포해보자.

- 격리된 스탠드얼론(standalone) 환경과 공유와 사용이 쉬운 재생산적인 환경을 도커 컨테이너를 활용하여 배포 환경에 적용할 수 있다.

#### 배포 환경에서의 볼륨, 바인드 마운트

- 보통 볼륨과 특히 바인드 마운트는 주로 개발환경에서 사용한다.
  
  - 이미지 리빌딩, 컨테이너 재시작 등의 작업없이 소스코드의 변경사항을 바로 적용이 가능하기 때문이다.

- 배포 환경에서는 볼륨과 바인드 마운트가 아닌 `COPY`를 통해 코드의 스냅샷을 이미지에 할당한다.

#### EC2 환경에서 도커 사용하기

- AWS EC2 인스턴스 생성

- ssh 클라이언트를 통해 생성 인스턴스 터미널에 접속
  
  - `sudo yum update -y`로 업데이트 확인 후, `sudo amazon-linux-extras install docker`로 ec2 터미널에 도커를 설치한다.

- `sudo service docker start`로 설치한 도커를 실행한다!

#### 도커 이미지를 클라우드로 푸시(push)하기

- 배포의 2가지 방법
  
  1. 소스코드 배포
  
  2. 생성 이미지를 배포
  
  2.의 방법으로 이미지 생성 후 dockerhub에 push 한다.

- 로컬에서 생성한 이미지를 클라우드인 dockerhub에 푸시한다.
  
  - `docker push dockerhub위치` -> 현재 로그인중인 도커 사용자의 repository에 푸쉬된다.

#### EC2에서 앱 실행 & 게시하기

- EC2 터미널에서 `docker run ~~ -p 포트번호:포트번호 dockerhub위치`로 컨테이너를 실행한다.

- **보안그룹**이 설정이 안되어있어, ssh 보안 키만 가진 사람만 접근이 가능하다.
  
  - 인바운드에 모두 접근이 가능한 HTTP 규칙을 추가한다.

- 이제 도커로 실행중인 어플리케이션은 AWS 환경을 통해 배포되었고, 누구나 어플리케이션 접근이 가능하다.

#### 컨테이너/이미지 관리 & 업데이트

- 로컬에서 수정한 애플리케이션의 소스코드를 AWS에 실행중인 컨테이너에 어떻게 반영할까?
  
  - Dockerhub에서 이미지를 pull하고 컨테이너를 실행하므로, dockerhub의 이미지를 수정하면 된다.
  
  - 수정된 image를 pull하여 컨테이너를 재실행한다.
    
    - 단순히 dockerhub에 push된 이미지로 컨테이너를 실행하면 수정사항이 반영되지 않는다. 도커는 로컬에 이미 존재한 이미지를 사용하기 때문에 로컬의 이미지를 리빌딩해줘야한다. 

### 수동배포에서 관리형 서비스로

- 이전까지는 이미지를 빌드와 컨테이너 실행을 사용자가 수동으로 진행했다.
  
  - AWS EC2에 한번에 관리하도록 설정을 변경한다.
  
  - 업데이트, 전체 관리 등을 한개의 서비스에서 관리 할 수 있다.

---

- 레퍼런스

> [Udemy - Docker & Kubernetes : 실전 가이드](https://www.udemy.com/course/docker-kubernetes-2022/)
